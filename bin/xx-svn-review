#!/usr/bin/env python
"""
Usage: REV1 REV2
Export two SVN revisions and review them.
"""
import sys, os, tempfile, logging, re, shutil
from subprocess import *
from os.path import *


def main():
    import optparse
    parser = optparse.OptionParser(__doc__.strip())

    parser.add_option('-u', '--url', action='store_true',
                      help="Specify the external URL to checkout.")

    opts, args = parser.parse_args()
    logging.basicConfig(level=logging.INFO, format='%(levelname)-8s: %(message)s')

    if len(args) == 1:
        r2 = int(args[0])
        r1 = r2 - 1
    elif len(args) == 2:
        r1, r2 = map(int, args)
    else:
        parser.error("Usage: [REV1] REV2")

    if not opts.url:
        if not isdir(join(os.getcwd(), '.svn')):
            parser.error("You must invoke this command in a working directory.")
        p = Popen(('svn', 'info'), shell=0, stdout=PIPE)
        out, _ = p.communicate()
        mo = re.search('^URL: (.*)', out, re.MULTILINE)
        url = mo.group(1)

    tempdir = tempfile.mkdtemp(prefix=basename(sys.argv[0]))
    for r in r1, r2:
        logging.info('Checking out %s' % r)
        ret = call(('svn', 'checkout', '-r%s' % r, url, join(tempdir, 'r%s' % r)),
                   shell=0, cwd=tempdir)
        if ret != 0:
            raise SystemExit("Error: checking out revision '%s'" % r)

    r = call(('xxdiff', '--exclude=.svn', '-r', join(tempdir, 'r%s' % r1), join(tempdir, 'r%s' % r2)),
             shell=0, cwd=tempdir)

    shutil.rmtree(tempdir)
        

if __name__ == '__main__':
    main()
